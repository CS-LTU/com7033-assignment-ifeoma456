<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Patient Records</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f2f5f7; margin: 20px; }
        nav a { margin: 0 10px; text-decoration: none; color: #0078d7; font-weight: bold; }
        .table-container { margin-top: 20px; }
        .small-col { width: 90px; text-align:center; }
        .nowrap { white-space: nowrap; }
        .pagination { user-select: none; }
    </style>
</head>
<body>
    <nav>
        <a href="{{ url_for('patients.add_patient') }}">Add Patient</a> |
        <a href="{{ url_for('auth.logout') }}">Logout</a> |
    </nav>

    <div class="container table-container">
        <h1 class="mt-3">Patient Records</h1>

        <div class="row mb-2">
            <div class="col-sm-6">
                <input id="searchInput" class="form-control form-control-sm" placeholder="Search patients (id, name, types, etc.)">
            </div>
            <div class="col-sm-3">
                <select id="rowsPerPage" class="form-select form-select-sm">
                    <option value="5">5 rows/page</option>
                    <option value="10" selected>10 rows/page</option>
                    <option value="25">25 rows/page</option>
                </select>
            </div>
            <div class="col-sm-3 text-end">
                <small id="rowsCount" class="text-muted"></small>
            </div>
        </div>

        {% if patients %}
        <div class="table-responsive">
            <table id="patientsTable" class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th class="small-col">ID</th>
                        <th>Gender</th>
                        <th class="small-col">Age</th>
                        <th class="small-col">Hypertension</th>
                        <th class="small-col">Heart Disease</th>
                        <th>Ever Married</th>
                        <th>Work Type</th>
                        <th>Residence</th>
                        <th class="nowrap">Avg Glucose</th>
                        <th class="small-col">BMI</th>
                        <th>Smoking Status</th>
                        <th class="small-col">Stroke</th>
                        <th class="small-col">Update</th>
                        <th class="small-col">Delete</th> 
                    </tr>
                </thead>
                <tbody>
                {% for patient in patients %}
                    <tr>
                        <td class="small-col">{{ patient.get('id') or 'N/A' }}</td>
                        <td>{{ patient.get('gender') or 'N/A' }}</td>
                        <td class="small-col">{{ patient.get('age') or 'N/A' }}</td>
                        <td class="small-col">{{ 'Yes' if patient.get('hypertension') else 'No' }}</td>
                        <td class="small-col">{{ 'Yes' if patient.get('heart_disease') else 'No' }}</td>
                        <td>{{ patient.get('ever_married') or 'N/A' }}</td>
                        <td>{{ patient.get('work_type') or 'N/A' }}</td>
                        <td>{{ patient.get('Residence_type') or 'N/A' }}</td>
                        <td class="nowrap">{{ patient.get('avg_glucose_level') or 'N/A' }}</td>
                        <td class="small-col">{{ patient.get('bmi') or 'N/A' }}</td>
                        <td>{{ patient.get('smoking_status') or 'N/A' }}</td>
                        <td class="small-col">{{ 'Yes' if patient.get('stroke') else 'No' }}</td>
                        <td class="small-col">
                            <a class="btn btn-sm btn-primary" href="{{ url_for('patients.edit_patient', patient_id=patient.get('_id')) }}">Update</a>
                        </td>
                           <td class="small-col">
                            <form method="POST" action="{{ url_for('patients.delete_patient', patient_id=patient.get('_id')) }}" onsubmit="return confirm('Are you sure you want to delete this patient?');" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <nav aria-label="Page navigation" class="mt-2">
            <ul id="paginationContainer" class="pagination justify-content-center"></ul>
        </nav>
        {% else %}
            <div class="alert alert-info">No patient records found yet.</div>
        {% endif %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const rowsPerPage = document.getElementById('rowsPerPage');
        const table = document.getElementById('patientsTable');
        const tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
        const paginationContainer = document.getElementById('paginationContainer');
        const rowsCountDisplay = document.getElementById('rowsCount');

        // prepare search text on rows
        tbodyRows.forEach(r => {
            r.dataset.searchText = Array.from(r.querySelectorAll('td')).map(td => td.textContent.trim().toLowerCase()).join(' ');
        });

        let filteredRows = tbodyRows.slice();
        let currentPage = 1;

        function renderRows() {
            const perPage = Number(rowsPerPage.value) || 10;
            const total = filteredRows.length;
            const totalPages = Math.max(1, Math.ceil(total / perPage));
            if (currentPage > totalPages) currentPage = totalPages;

            // hide all rows
            tbodyRows.forEach(r => r.style.display = 'none');

            // show current page rows
            const start = (currentPage - 1) * perPage;
            const chunk = filteredRows.slice(start, start + perPage);
            chunk.forEach(r => r.style.display = '');

            rowsCountDisplay.textContent = `${total} row(s)`;
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const maxBtns = 7;
            paginationContainer.innerHTML = '';

            function createPageItem(label, page, active=false, disabled=false) {
                const li = document.createElement('li');
                li.className = `page-item ${active? 'active':''} ${disabled? 'disabled':''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = label;
                a.addEventListener('click', function (e) { e.preventDefault(); if(!disabled){ currentPage = page; renderRows(); }});
                li.appendChild(a);
                return li;
            }

            paginationContainer.appendChild(createPageItem('Prev', Math.max(1, currentPage - 1), false, currentPage === 1));

            // show numeric pages
            let startPage = Math.max(1, currentPage - Math.floor(maxBtns / 2));
            let endPage = Math.min(totalPages, startPage + maxBtns - 1);
            if (endPage - startPage + 1 < maxBtns) {
                startPage = Math.max(1, endPage - maxBtns + 1);
            }

            for (let p = startPage; p <= endPage; p++) {
                paginationContainer.appendChild(createPageItem(p, p, p === currentPage));
            }

            paginationContainer.appendChild(createPageItem('Next', Math.min(totalPages, currentPage + 1), false, currentPage === totalPages));
        }

        function filterRows() {
            const term = searchInput.value.trim().toLowerCase();
            filteredRows = tbodyRows.filter(r => r.dataset.searchText.includes(term));
            currentPage = 1;
            renderRows();
        }

        searchInput.addEventListener('input', filterRows);
        rowsPerPage.addEventListener('change', function() { currentPage = 1; renderRows(); });

        // initial render
        renderRows();
    });
    </script>
</body>
</html>