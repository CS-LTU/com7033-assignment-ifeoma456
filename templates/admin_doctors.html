{% extends "base.html" %}

{% block title %}Admin - Doctors Management{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-left-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Total Doctors</h6>
                            <h2 class="text-primary">{{ stats.total_doctors }}</h2>
                        </div>
                        <i class="fas fa-user-md fa-3x text-primary ml-auto" style="opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-left-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Active Doctors</h6>
                            <h2 class="text-success">{{ stats.active_doctors }}</h2>
                        </div>
                        <i class="fas fa-check-circle fa-3x text-success ml-auto" style="opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-left-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Total Patients</h6>
                            <h2 class="text-info">{{ stats.total_patients }}</h2>
                        </div>
                        <i class="fas fa-users fa-3x text-info ml-auto" style="opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-left-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Total Activities</h6>
                            <h2 class="text-warning">{{ stats.total_activities }}</h2>
                        </div>
                        <i class="fas fa-history fa-3x text-warning ml-auto" style="opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Doctors Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Doctors Management</h4>
        </div>
        <div class="card-body">
            {% if doctors %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Specialization</th>
                            <th>Experience</th>
                            <th>Patients</th>
                            <th>Activities</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doctor in doctors %}
                        <tr>
                            <td>#{{ doctor.id }}</td>
                            <td><strong>{{ doctor.full_name }}</strong></td>
                            <td>{{ doctor.specialization }}</td>
                            <td>{{ doctor.experience_years or 0 }} years</td>
                            <td><span class="badge bg-info">{{ doctor.patient_count or 0 }}</span></td>
                            <td><span class="badge bg-secondary">{{ doctor.activity_count or 0 }}</span></td>
                            <td>
                                {% if doctor.availability_status == 'available' %}
                                <span class="badge bg-success">Available</span>
                                {% else %}
                                <span class="badge bg-warning">{{ doctor.availability_status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editModal{{ doctor.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No doctors found.</p>
            {% endif %}
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Recent System Activities</h5>
        </div>
        <div class="card-body">
            {% if recent_activities %}
            <div class="timeline">
                {% for activity in recent_activities %}
                <div class="timeline-item mb-3 pb-3 border-bottom">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <span class="badge bg-primary text-capitalize">
                                    {{ activity.action_type.replace('_', ' ') }}
                                </span>
                            </h6>
                            <p class="mb-1"><strong>{{ activity.doctor_name or 'Unknown' }}</strong> - {{ activity.patient_name or 'General' }}</p>
                            <p class="small text-muted mb-0">{{ activity.details or '-' }}</p>
                            <p class="small text-muted">{{ activity.timestamp }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No activities recorded yet.</p>
            {% endif %}
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">Back to Admin Panel</a>
    </div>
</div>

<!-- Edit Modals for each doctor -->
{% for doctor in doctors %}
<div class="modal fade" id="editModal{{ doctor.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Doctor - {{ doctor.full_name }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_edit_doctor', doctor_id=doctor.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Specialization</label>
                        <input type="text" class="form-control" name="specialization" value="{{ doctor.specialization or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Number</label>
                        <input type="text" class="form-control" name="contact_number" value="{{ doctor.contact_number or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Qualification</label>
                        <input type="text" class="form-control" name="qualification" value="{{ doctor.qualification or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Experience (Years)</label>
                        <input type="number" class="form-control" name="experience_years" value="{{ doctor.experience_years or 0 }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Consultation Fee ($)</label>
                        <input type="number" step="0.01" class="form-control" name="consultation_fee" value="{{ doctor.consultation_fee or 0 }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Availability Status</label>
                        <select class="form-control" name="availability_status">
                            <option value="available" {% if doctor.availability_status == 'available' %}selected{% endif %}>Available</option>
                            <option value="on_leave" {% if doctor.availability_status == 'on_leave' %}selected{% endif %}>On Leave</option>
                            <option value="unavailable" {% if doctor.availability_status == 'unavailable' %}selected{% endif %}>Unavailable</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bio</label>
                        <textarea class="form-control" name="bio" rows="3">{{ doctor.bio or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
